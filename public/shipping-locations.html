<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Locations - Treasure Hunter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            font-size: 14px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #666;
            font-size: 18px;
        }

        .setup-flow {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-radius: 20px;
            color: #666;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .step.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .step-number {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .location-form {
            display: grid;
            gap: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .saved-locations {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .location-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .location-card.default {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .location-card .default-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .location-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .location-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-small:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .btn-small.danger:hover {
            border-color: #dc3545;
            color: #dc3545;
        }

        .location-address {
            color: #666;
            line-height: 1.4;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
            display: none;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #1565c0;
            line-height: 1.5;
        }

        .marketplace-sync {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }

        .sync-indicator.syncing {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .sync-indicator.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .setup-flow,
            .saved-locations {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .step-indicator {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <a href="/dashboard.html" class="logo">
                üè¥‚Äç‚ò†Ô∏è Treasure Hunter
            </a>
            <div class="nav-actions">
                <a href="/dashboard.html" class="nav-btn">üè† Dashboard</a>
                <a href="/profile.html" class="nav-btn">üë§ Profile</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1 id="pageTitle">Shipping Locations</h1>
            <p>Set up your shipping locations for marketplace listings</p>
        </div>

        <div class="info-box">
            <h3>Why do I need shipping locations?</h3>
            <p>
                Shipping locations tell marketplaces where your items will ship from. This helps calculate 
                accurate shipping costs, delivery times, and ensures compliance with international selling 
                requirements. You can set up multiple locations and choose which one to use for each listing.
            </p>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="success"></div>

        <!-- Location Setup Form -->
        <div class="setup-flow" id="setupSection">
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <span>Add Location</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <span>Sync to Marketplaces</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <span>Start Listing</span>
                </div>
            </div>

            <form class="location-form" id="locationForm">
                <div class="form-group full-width">
                    <label for="locationName">Location Name *</label>
                    <input type="text" id="locationName" placeholder="e.g., Home Office, Main Warehouse" required>
                </div>

                <div class="form-group full-width">
                    <label for="address">Street Address *</label>
                    <input type="text" id="address" placeholder="123 Main Street" required>
                </div>

                <div class="form-group full-width">
                    <label for="address2">Address Line 2 (Optional)</label>
                    <input type="text" id="address2" placeholder="Apt, Suite, etc.">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" placeholder="New York" required>
                    </div>
                    <div class="form-group">
                        <label for="state">State/Province *</label>
                        <input type="text" id="state" placeholder="NY" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="postalCode">Postal Code *</label>
                        <input type="text" id="postalCode" placeholder="10001" required>
                    </div>
                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="phone">Phone Number (Optional)</label>
                    <input type="tel" id="phone" placeholder="+1 (555) 123-4567">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isDefault">
                    <label for="isDefault">Set as default shipping location</label>
                </div>

                <button type="submit" class="btn btn-primary" id="saveBtn">
                    üíæ Save Location
                </button>
            </form>
        </div>

        <!-- Saved Locations -->
        <div class="saved-locations" id="savedLocationsSection">
            <h3>Your Shipping Locations</h3>
            <div id="locationsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading your locations...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDymYwo7NUAu7lhoPfS9KLQmckvVgky7PU",
            authDomain: "treasurehunter-sdk.firebaseapp.com",
            projectId: "treasurehunter-sdk",
            storageBucket: "treasurehunter-sdk.firebasestorage.app",
            messagingSenderId: "328804663359",
            appId: "1:328804663359:web:eb124f150c4853c123788a",
            measurementId: "G-YNJ58GLX3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = {};
        let editingLocationId = null;
        let returnToUrl = null;
        let fromListing = false;

        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.uid);
                await loadUserData();
                await loadShippingLocations();
                handleReturnNavigation();
            } else {
                window.location.href = '/signin.html';
            }
        });

        // Handle return navigation from URL parameters
        function handleReturnNavigation() {
            const urlParams = new URLSearchParams(window.location.search);
            returnToUrl = urlParams.get('returnTo');
            fromListing = urlParams.get('from') === 'listing';
            
            if (fromListing && returnToUrl) {
                showSuccess('Once you set up a location, you can continue creating your listing');
                document.getElementById('pageTitle').textContent = 'Set Up Shipping Location to Continue';
            }
        }

        // Load user data from Firestore
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('User data loaded successfully');
                } else {
                    console.error('User document not found');
                    showError('User profile not found. Please refresh the page.');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data: ' + error.message);
            }
        }

        // Load shipping locations
        async function loadShippingLocations() {
            try {
                const locations = userData.shippingLocations || [];
                displayLocations(locations);
            } catch (error) {
                console.error('Error loading shipping locations:', error);
                showError('Failed to load locations: ' + error.message);
            }
        }

        // Display locations
        function displayLocations(locations) {
            const container = document.getElementById('locationsContainer');
            
            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No shipping locations yet</h3>
                        <p>Add your first location above to start creating eBay listings</p>
                    </div>
                `;
                return;
            }

            let html = '';
            locations.forEach((location, index) => {
                html += createLocationCard(location, index);
            });
            
            container.innerHTML = html;
        }

        // Create location card HTML
        function createLocationCard(location, index) {
            const isDefault = location.isDefault || false;
            
            return `
                <div class="location-card ${isDefault ? 'default' : ''}" data-index="${index}">
                    ${isDefault ? '<div class="default-badge">Default</div>' : ''}
                    <div class="location-header">
                        <div class="location-name">${location.name}</div>
                        <div class="location-actions">
                            <button class="btn-small" onclick="editLocation(${index})">Edit</button>
                            ${!isDefault ? `<button class="btn-small" onclick="setAsDefault(${index})">Set Default</button>` : ''}
                            <button class="btn-small danger" onclick="deleteLocation(${index})">Delete</button>
                        </div>
                    </div>
                    <div class="location-address">
                        ${location.address}<br>
                        ${location.address2 ? location.address2 + '<br>' : ''}
                        ${location.city}, ${location.state} ${location.postalCode}<br>
                        ${getCountryName(location.country)}
                        ${location.phone ? '<br>Phone: ' + location.phone : ''}
                    </div>
                    ${isDefault ? 
                        `<div class="marketplace-sync">
                            <div class="sync-status">
                                <div class="sync-indicator"></div>
                                <span>Synced to marketplaces</span>
                            </div>
                        </div>` : ''
                    }
                </div>
            `;
        }

        // Form submission
        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const formData = getFormData();
            
            try {
                showLoading(true);
                
                let locations = [...(userData.shippingLocations || [])];
                
                if (editingLocationId !== null) {
                    // Update existing location
    locations[editingLocationId] = { ...locations[editingLocationId], ...formData };
                    showSuccess('Location updated successfully!');
                } else {
                    // Add new location
                    locations.push(formData);
                    showSuccess('Location added successfully!');
                }

                // If this is the first location or marked as default, make it default
                if (formData.isDefault || locations.length === 1) {
                    locations.forEach((loc, idx) => {
                        loc.isDefault = (editingLocationId !== null ? idx === editingLocationId : idx === locations.length - 1);
                    });
                }

                // Update user document
                await db.collection('users').doc(currentUser.uid).update({
                    shippingLocations: locations,
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });

                userData.shippingLocations = locations;
                displayLocations(locations);
                resetForm();
                updateSteps();

                // Handle return navigation after successful save
                if (fromListing && returnToUrl) {
                    setTimeout(() => {
                        window.location.href = decodeURIComponent(returnToUrl);
                    }, 2000);
                }

            } catch (error) {
                console.error('Error saving location:', error);
                showError('Failed to save location: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Get form data
        function getFormData() {
            return {
                id: editingLocationId !== null ? userData.shippingLocations[editingLocationId].id : `loc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: document.getElementById('locationName').value.trim(),
                address: document.getElementById('address').value.trim(),
                address2: document.getElementById('address2').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value.trim(),
                isDefault: document.getElementById('isDefault').checked,
                createdAt: editingLocationId !== null ? userData.shippingLocations[editingLocationId].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        // Validate form
        function validateForm() {
            const requiredFields = ['locationName', 'address', 'city', 'state', 'postalCode', 'country'];
            let isValid = true;

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showError(`Please fill in the ${field.previousElementSibling.textContent.replace(' *', '')}`);
                    field.focus();
                    return false;
                }
            }

            // Validate postal code format
            const postalCode = document.getElementById('postalCode').value.trim();
            const country = document.getElementById('country').value;
            
            if (!validatePostalCode(postalCode, country)) {
                showError('Please enter a valid postal code for the selected country');
                document.getElementById('postalCode').focus();
                return false;
            }

            return true;
        }

        // Validate postal code format by country
        function validatePostalCode(postalCode, country) {
            const patterns = {
                'US': /^\d{5}(-\d{4})?$/,
                'CA': /^[A-Za-z]\d[A-Za-z] ?\d[A-Za-z]\d$/,
                'GB': /^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/i,
                'AU': /^\d{4}$/,
                'DE': /^\d{5}$/,
                'FR': /^\d{5}$/,
                'IT': /^\d{5}$/,
                'ES': /^\d{5}$/
            };

            if (!patterns[country]) {
                return postalCode.length >= 3; // Basic validation for other countries
            }

            return patterns[country].test(postalCode);
        }

        // Edit location
        function editLocation(index) {
            const location = userData.shippingLocations[index];
            editingLocationId = index;

            // Populate form
            document.getElementById('locationName').value = location.name;
            document.getElementById('address').value = location.address;
            document.getElementById('address2').value = location.address2 || '';
            document.getElementById('city').value = location.city;
            document.getElementById('state').value = location.state;
            document.getElementById('postalCode').value = location.postalCode;
            document.getElementById('country').value = location.country;
            document.getElementById('phone').value = location.phone || '';
            document.getElementById('isDefault').checked = location.isDefault || false;

            // Update UI
            document.getElementById('saveBtn').textContent = 'üíæ Update Location';
            document.getElementById('setupSection').scrollIntoView({ behavior: 'smooth' });
            showSuccess('Location loaded for editing. Make your changes and click Update.');
        }

        // Set as default
        async function setAsDefault(index) {
            try {
                showLoading(true);
                
                let locations = [...userData.shippingLocations];
                
                // Remove default from all locations
                locations.forEach(loc => loc.isDefault = false);
                // Set new default
                locations[index].isDefault = true;

                await db.collection('users').doc(currentUser.uid).update({
                    shippingLocations: locations,
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });

                userData.shippingLocations = locations;
                displayLocations(locations);
                showSuccess('Default location updated successfully!');

            } catch (error) {
                console.error('Error setting default location:', error);
                showError('Failed to set default location: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Delete location
        async function deleteLocation(index) {
            const location = userData.shippingLocations[index];
            
            if (!confirm(`Are you sure you want to delete "${location.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                showLoading(true);
                
                let locations = [...userData.shippingLocations];
                locations.splice(index, 1);

                // If we deleted the default location and there are other locations, make the first one default
                if (location.isDefault && locations.length > 0) {
                    locations[0].isDefault = true;
                }

                await db.collection('users').doc(currentUser.uid).update({
                    shippingLocations: locations,
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });

                userData.shippingLocations = locations;
                displayLocations(locations);
                showSuccess('Location deleted successfully!');

            } catch (error) {
                console.error('Error deleting location:', error);
                showError('Failed to delete location: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('locationForm').reset();
            editingLocationId = null;
            document.getElementById('saveBtn').textContent = 'üíæ Save Location';
        }

        // Update step indicators
        function updateSteps() {
            const hasLocations = userData.shippingLocations && userData.shippingLocations.length > 0;
            
            if (hasLocations) {
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step2').classList.add('active');
                
                setTimeout(() => {
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('active');
                }, 1000);
            }
        }

        // Get country name from code
        function getCountryName(code) {
            const countries = {
                'US': 'United States',
                'CA': 'Canada',
                'GB': 'United Kingdom',
                'AU': 'Australia',
                'DE': 'Germany',
                'FR': 'France',
                'IT': 'Italy',
                'ES': 'Spain'
            };
            return countries[code] || code;
        }

        // Utility functions
        function showLoading(show) {
            const saveBtn = document.getElementById('saveBtn');
            if (show) {
                saveBtn.disabled = true;
                saveBtn.textContent = editingLocationId !== null ? '‚è≥ Updating...' : '‚è≥ Saving...';
            } else {
                saveBtn.disabled = false;
                saveBtn.textContent = editingLocationId !== null ? 'üíæ Update Location' : 'üíæ Save Location';
            }
        }

        function showSuccess(message) {
            console.log('‚úÖ', message);
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            successDiv.scrollIntoView({ behavior: 'smooth' });
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            console.error('‚ùå', message);
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Phone number formatting
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = `(${value}`;
                } else if (value.length <= 6) {
                    value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                } else {
                    value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
                }
            }
            e.target.value = value;
        });

        // Postal code formatting
        document.getElementById('postalCode').addEventListener('input', function(e) {
            const country = document.getElementById('country').value;
            let value = e.target.value.toUpperCase();
            
            if (country === 'CA') {
                // Canadian postal code formatting: A1A 1A1
                value = value.replace(/\s/g, '');
                if (value.length > 3) {
                    value = value.slice(0, 3) + ' ' + value.slice(3, 6);
                }
            } else if (country === 'US') {
                // US ZIP code formatting: 12345 or 12345-6789
                value = value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.slice(0, 5) + '-' + value.slice(5, 9);
                }
            }
            
            e.target.value = value;
        });

        // Country change handler
        document.getElementById('country').addEventListener('change', function(e) {
            const postalCodeField = document.getElementById('postalCode');
            const stateField = document.getElementById('state');
            const country = e.target.value;
            
            // Update placeholder text based on country
            switch (country) {
                case 'US':
                    postalCodeField.placeholder = '12345 or 12345-6789';
                    stateField.placeholder = 'NY';
                    break;
                case 'CA':
                    postalCodeField.placeholder = 'A1A 1A1';
                    stateField.placeholder = 'ON';
                    break;
                case 'GB':
                    postalCodeField.placeholder = 'SW1A 1AA';
                    stateField.placeholder = 'England';
                    break;
                case 'AU':
                    postalCodeField.placeholder = '2000';
                    stateField.placeholder = 'NSW';
                    break;
                default:
                    postalCodeField.placeholder = 'Postal Code';
                    stateField.placeholder = 'State/Province';
            }
            
            // Clear and reformat postal code if it exists
            if (postalCodeField.value) {
                const event = new Event('input');
                postalCodeField.dispatchEvent(event);
            }
        });

        // Auto-save draft functionality
        let autoSaveTimeout;
        const formFields = ['locationName', 'address', 'address2', 'city', 'state', 'postalCode', 'country', 'phone'];

        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.addEventListener('input', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(saveDraft, 2000);
            });
        });

        function saveDraft() {
            const formData = getFormData();
            localStorage.setItem('shippingLocationDraft', JSON.stringify(formData));
            console.log('Draft saved automatically');
        }

        function loadDraft() {
            const draft = localStorage.getItem('shippingLocationDraft');
            if (draft) {
                const data = JSON.parse(draft);
                Object.keys(data).forEach(key => {
                    const field = document.getElementById(key === 'name' ? 'locationName' : key);
                    if (field && data[key]) {
                        if (field.type === 'checkbox') {
                            field.checked = data[key];
                        } else {
                            field.value = data[key];
                        }
                    }
                });
                showSuccess('Draft restored from previous session');
            }
        }

        function clearDraft() {
            localStorage.removeItem('shippingLocationDraft');
        }

        // Load draft on page load
        window.addEventListener('load', () => {
            // Only load draft if not editing existing location
            if (editingLocationId === null) {
                setTimeout(loadDraft, 1000);
            }
        });

        // Clear draft when form is successfully submitted
        document.getElementById('locationForm').addEventListener('submit', () => {
            clearDraft();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveBtn').click();
            }
            
            // Escape to reset form
            if (e.key === 'Escape' && editingLocationId !== null) {
                resetForm();
                showSuccess('Edit cancelled');
            }
        });

        // Address validation helper
        function validateAddress() {
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();
            
            // Basic address validation
            if (address.length < 5) {
                return 'Street address seems too short';
            }
            
            if (city.length < 2) {
                return 'Please enter a valid city name';
            }
            
            if (state.length < 2) {
                return 'Please enter a valid state/province';
            }
            
            return null;
        }

        // Enhanced form validation
        document.getElementById('locationForm').addEventListener('input', (e) => {
            const field = e.target;
            
            // Remove any existing error styling
            field.style.borderColor = '';
            
            // Real-time validation
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.style.borderColor = '#f44336';
            } else if (field.id === 'postalCode') {
                const country = document.getElementById('country').value;
                if (country && !validatePostalCode(field.value.trim(), country)) {
                    field.style.borderColor = '#f44336';
                } else {
                    field.style.borderColor = '#4caf50';
                }
            } else if (field.hasAttribute('required')) {
                field.style.borderColor = '#4caf50';
            }
        });

        // Initialize tooltips and help text
        function addHelpText() {
            const helpTexts = {
                'locationName': 'Give this location a memorable name like "Home Office" or "Warehouse"',
                'address': 'Enter the full street address where items will ship from',
                'postalCode': 'Format will be validated based on selected country',
                'phone': 'Optional - used for shipping carrier contact if needed'
            };

            Object.keys(helpTexts).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.title = helpTexts[fieldId];
                }
            });
        }

        // Initialize help text on page load
        document.addEventListener('DOMContentLoaded', addHelpText);

        console.log('‚úÖ Shipping Locations functionality initialized');
    </script>
</body>
</html>