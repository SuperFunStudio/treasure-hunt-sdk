<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create eBay Listing - Treasure Hunter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .workflow-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .workflow-header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .workflow-header p {
            color: #666;
            font-size: 18px;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: 600;
        }
        
        .workflow-step.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .workflow-step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .workflow-step.completed .step-number {
            background: #4caf50;
            color: white;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .listing-preview {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .listing-photos {
            margin-bottom: 30px;
        }
        
        .main-photo {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 15px;
            border: 2px solid #f0f0f0;
        }
        
        .photo-thumbnails {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            max-height: 80px;
            overflow-x: auto;
        }
        
        .thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .thumbnail:hover,
        .thumbnail.active {
            border-color: #667eea;
        }
        
        .listing-details h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
            line-height: 1.3;
        }
        
        .price-info {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .price-main {
            font-size: 32px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        
        .price-details {
            font-size: 14px;
            color: #4caf50;
        }
        
        .listing-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .meta-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .meta-value {
            color: #333;
            font-weight: 500;
        }
        
        .description-preview {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .description-preview h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .description-text {
            color: #666;
            line-height: 1.6;
            white-space: pre-line;
        }
        
        .listing-settings {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-section h3 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .calculation-summary {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .calc-row.total {
            border-top: 1px solid #2196f3;
            margin-top: 15px;
            padding-top: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #1976d2;
        }
        
        .shipping-options {
            display: grid;
            gap: 15px;
        }
        
        .shipping-option {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shipping-option:hover {
            border-color: #667eea;
        }
        
        .shipping-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .ebay-status {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .ebay-status.connected {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .ebay-status.disconnected {
            color: #ef6c00;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 40px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .preview-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .workflow-steps {
                flex-direction: column;
                align-items: center;
            }
            
            .pricing-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <a href="/dashboard.html" class="logo">
                üè¥‚Äç‚ò†Ô∏è Treasure Hunter
            </a>
            
            <div class="nav-actions">
                <a href="/dashboard.html" class="nav-btn">üè† Dashboard</a>
                <a href="/profile.html" class="nav-btn">üë§ Profile</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Workflow Header -->
        <div class="workflow-header">
            <h1>Create Your eBay Listing</h1>
            <p>Review and finalize your listing before publishing to eBay</p>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
            <div class="workflow-step completed">
                <div class="step-number">‚úì</div>
                <span>Scan Item</span>
            </div>
            <div class="workflow-step completed">
                <div class="step-number">‚úì</div>
                <span>Review & Edit</span>
            </div>
            <div class="workflow-step completed">
                <div class="step-number">‚úì</div>
                <span>Listing Photos</span>
            </div>
            <div class="workflow-step active">
                <div class="step-number">4</div>
                <span>Create Listing</span>
            </div>
        </div>

        <!-- eBay Connection Status -->
        <div id="ebayStatus" class="ebay-status">
            Checking eBay connection...
        </div>

        <!-- Error/Success Messages -->
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>

        <!-- Preview Container -->
        <div class="preview-container">
            <!-- Listing Preview -->
            <div class="listing-preview">
                <h3 style="margin-bottom: 20px; color: #333;">üìã Listing Preview</h3>
                
                <div class="listing-photos">
                    <img id="mainPhoto" class="main-photo" src="" alt="Main listing photo">
                    <div class="photo-thumbnails" id="photoThumbnails">
                        <!-- Thumbnails will be populated dynamically -->
                    </div>
                </div>

                <div class="listing-details">
                    <h2 id="listingTitle">Loading...</h2>
                    
                    <div class="price-info">
                        <div class="price-main" id="listingPrice">$0.00</div>
                        <div class="price-details">Starting price ‚Ä¢ Best Offer accepted</div>
                    </div>

                    <div class="listing-meta">
                        <div class="meta-item">
                            <div class="meta-label">Condition</div>
                            <div class="meta-value" id="listingCondition">Used</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Category</div>
                            <div class="meta-value" id="listingCategory">Electronics</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Brand</div>
                            <div class="meta-value" id="listingBrand">Unknown</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Shipping</div>
                            <div class="meta-value">Calculated</div>
                        </div>
                    </div>

                    <div class="description-preview">
                        <h3>Description</h3>
                        <div class="description-text" id="listingDescription">
                            Loading description...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listing Settings -->
            <div class="listing-settings">
                <div class="settings-section">
                    <h3>üí∞ Pricing Strategy</h3>
                    
                    <div class="pricing-grid">
                        <div class="form-group">
                            <label for="startingPrice">Starting Price ($)</label>
                            <input type="number" id="startingPrice" min="0.99" step="0.01" value="9.99">
                        </div>
                        
                        <div class="form-group">
                            <label for="buyItNowPrice">Buy It Now ($)</label>
                            <input type="number" id="buyItNowPrice" min="0.99" step="0.01" value="19.99">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="acceptOffers" checked style="margin-right: 8px;">
                            Accept Best Offers
                        </label>
                    </div>

                    <div class="calculation-summary">
                        <h4 style="margin-bottom: 15px; color: #1976d2;">üí° Profit Calculation</h4>
                        <div class="calc-row">
                            <span>Starting Price:</span>
                            <span id="calcStartPrice">$9.99</span>
                        </div>
                        <div class="calc-row">
                            <span>eBay Fees (13.25%):</span>
                            <span id="calcEbayFees">$1.32</span>
                        </div>
                        <div class="calc-row">
                            <span>Estimated Shipping:</span>
                            <span id="calcShipping">$8.00</span>
                        </div>
                        <div class="calc-row total">
                            <span>Your Net Profit:</span>
                            <span id="calcNetProfit">$0.67</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üì¶ Shipping Options</h3>
                    
                    <div class="shipping-options">
                        <div class="shipping-option selected" data-service="calculated">
                            <strong>Calculated Shipping</strong>
                            <p>Buyer pays actual shipping cost based on location</p>
                        </div>
                        
                        <div class="shipping-option" data-service="free">
                            <strong>Free Shipping</strong>
                            <p>Include shipping cost in item price</p>
                        </div>
                        
                        <div class="shipping-option" data-service="flat">
                            <strong>Flat Rate Shipping</strong>
                            <p>Fixed shipping cost for all buyers</p>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>‚öôÔ∏è Listing Options</h3>
                    
                    <div class="form-group">
                        <label for="duration">Listing Duration</label>
                        <select id="duration">
                            <option value="7">7 Days</option>
                            <option value="10" selected>10 Days</option>
                            <option value="30">30 Days (Good Till Cancelled)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="returnPolicy">Return Policy</label>
                        <select id="returnPolicy">
                            <option value="30_days">30 Day Returns</option>
                            <option value="14_days">14 Day Returns</option>
                            <option value="no_returns" selected>No Returns</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goBack()">
                ‚Üê Back to Photos
            </button>
            <button class="btn btn-secondary" onclick="saveDraft()">
                üíæ Save Draft
            </button>
            <button class="btn btn-success" id="createListingBtn" disabled>
                üöÄ Create eBay Listing
            </button>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingText">Creating eBay listing...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = 'https://app-beprv7ll2q-uc.a.run.app';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDymYwo7NUAu7lhoPfS9KLQmckvVgky7PU",
            authDomain: "treasurehunter-sdk.firebaseapp.com",
            projectId: "treasurehunter-sdk",
            storageBucket: "treasurehunter-sdk.firebasestorage.app",
            messagingSenderId: "328804663359",
            appId: "1:328804663359:web:eb124f150c4853c123788a",
            measurementId: "G-YNJ58GLX3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let userData = {};
        let currentScanId = null;
        let scanData = null;
        let listingData = null;

        // UI Elements
        const ebayStatus = document.getElementById('ebayStatus');
        const mainPhoto = document.getElementById('mainPhoto');
        const photoThumbnails = document.getElementById('photoThumbnails');
        const listingTitle = document.getElementById('listingTitle');
        const listingPrice = document.getElementById('listingPrice');
        const listingCondition = document.getElementById('listingCondition');
        const listingCategory = document.getElementById('listingCategory');
        const listingBrand = document.getElementById('listingBrand');
        const listingDescription = document.getElementById('listingDescription');
        const startingPrice = document.getElementById('startingPrice');
        const buyItNowPrice = document.getElementById('buyItNowPrice');
        const acceptOffers = document.getElementById('acceptOffers');
        const createListingBtn = document.getElementById('createListingBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loadingState = document.getElementById('loadingState');

        // ===== SECURE FIREBASE SDK CLASS =====
        class SecureFirebaseSDK {
            constructor() {
                this.apiBaseUrl = API_BASE_URL;
                this.initialized = false;
            }

            async init() {
                if (this.initialized) return;
                
                // Wait for Firebase Auth to be ready
                return new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        if (user) {
                            this.currentUser = user;
                            this.initialized = true;
                            unsubscribe();
                            resolve();
                        }
                    });
                });
            }

            async getAuthToken() {
                if (!this.currentUser) {
                    throw new Error('User not authenticated');
                }
                return await this.currentUser.getIdToken();
            }

            async getEbayAccountInfo() {
                try {
                    const token = await this.getAuthToken();
                    
                    const response = await fetch(`${this.apiBaseUrl}/api/ebay/account-info`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to get eBay account info');
                    }

                    return result;

                } catch (error) {
                    console.error('‚ùå Error getting eBay account info:', error);
                    throw error;
                }
            }

            async createEbayListing(listingData) {
    try {
        console.log('üõí Creating eBay listing with category validation...');
        
        // Pre-validate the category
        if (listingData.category) {
            const categoryId = await this.testCategoryMapping(listingData.category);
            if (!categoryId) {
                throw new Error(`Invalid category: ${listingData.category}. Please refresh and try again.`);
            }
            console.log(`Category "${listingData.category}" validated -> eBay ID: ${categoryId}`);
        }
        
        const token = await this.getAuthToken();
        
        const response = await fetch(`${this.apiBaseUrl}/api/ebay/create-listing`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(listingData)
        });

        const result = await response.json();
        
        if (!response.ok) {
            // Handle specific category errors
            if (result.error && result.error.includes('category')) {
                console.log('Category error detected, reinitializing categories...');
                await this.initializeEbayCategories();
                throw new Error(`Category mapping error: ${result.error}. Please try again.`);
            }
            
            throw new Error(result.error || 'Failed to create eBay listing');
        }

        console.log('‚úÖ eBay listing created successfully:', result);
        return result;

    } catch (error) {
        console.error('‚ùå Error creating eBay listing:', error);
        throw error;
    }
}

            async refreshEbayToken(refreshToken) {
                try {
                    console.log('üîÑ Refreshing eBay token via secure backend...');
                    
                    const token = await this.getAuthToken();
                    
                    const response = await fetch(`${this.apiBaseUrl}/refreshEbayToken`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ refreshToken })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Failed to refresh eBay token');
                    }

                    console.log('‚úÖ eBay token refreshed successfully');
                    return result;

                } catch (error) {
                    console.error('‚ùå Error refreshing eBay token:', error);
                    throw error;
                }
            }

            async callEbayAPI(method, endpoint, body = null, accessToken = null) {
                try {
                    console.log(`üîó Calling eBay API via proxy: ${method} ${endpoint}`);
                    
                    const token = await this.getAuthToken();
                    
                    const response = await fetch(`${this.apiBaseUrl}/ebayApiProxy`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            method,
                            endpoint,
                            body,
                            accessToken
                        })
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'eBay API call failed');
                    }

                    return result.data;

                } catch (error) {
                    console.error('‚ùå Error calling eBay API:', error);
                    throw error;
                }

                
            }
    async initializeEbayCategories() {
    console.log('Initializing eBay categories...');
    
    try {
        const response = await fetch(`${this.apiBaseUrl}/api/ebay/init-categories`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Category initialization failed: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('eBay categories initialized successfully');
            localStorage.setItem('ebayCategories', JSON.stringify(result.mapping));
            localStorage.setItem('ebayCategoriesTimestamp', Date.now().toString());
            return result.mapping;
        } else {
            console.warn('Category initialization returned failure:', result.error);
            return result.fallbackMapping || null;
        }
        
    } catch (error) {
        console.error('Failed to initialize eBay categories:', error);
        return null;
    }
}
async testCategoryMapping(category) {
    try {
        const response = await fetch(`${this.apiBaseUrl}/api/ebay/test-category`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ category })
        });
        
        if (!response.ok) {
            throw new Error(`Category test failed: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            return result.mapped;
        } else {
            console.error('Category test failed:', result.error);
            return null;
        }
        
    } catch (error) {
        console.error('Category test error:', error);
        return null;
    }
}
    }

    

        // Initialize the secure SDK
        const secureSDK = new SecureFirebaseSDK();

        // Check authentication and load data
        auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        await secureSDK.init();
        await loadUserData();
        await loadScanData();
        await checkEbayConnection();
        
        // ADD THIS: Initialize categories
        const cachedCategories = localStorage.getItem('ebayCategories');
        const cacheTimestamp = localStorage.getItem('ebayCategoriesTimestamp');
        const oneHourAgo = Date.now() - (60 * 60 * 1000);
        
        if (!cachedCategories || !cacheTimestamp || parseInt(cacheTimestamp) < oneHourAgo) {
            console.log('Categories cache is stale or missing, initializing...');
            await secureSDK.initializeEbayCategories();
        } else {
            console.log('Using cached eBay categories');
        }
    } else {
        window.location.href = '/signin.html';
    }
});


        // Load user data
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load scan data
        async function loadScanData() {
            const urlParams = new URLSearchParams(window.location.search);
            currentScanId = urlParams.get('scanId');
            
            if (!currentScanId) {
                showError('No scan ID provided');
                return;
            }

            try {
                showLoading(true, 'Loading listing data...');
                
                const scanDoc = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('scans')
                    .doc(currentScanId)
                    .get();
                
                if (!scanDoc.exists) {
                    showError('Scan not found');
                    return;
                }
                
                scanData = scanDoc.data();
                console.log('Scan data loaded:', scanData);
                
                // Generate listing data
                await generateListingData();
                
                // Display the listing preview
                displayListingPreview();
                
                // Setup form handlers
                setupFormHandlers();
                
            } catch (error) {
                console.error('Error loading scan data:', error);
                showError('Failed to load listing data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Check eBay connection status using secure backend
        async function checkEbayConnection() {
            try {
                const accountInfo = await secureSDK.getEbayAccountInfo();
                
                if (accountInfo.success && accountInfo.connected) {
                    ebayStatus.className = 'ebay-status connected';
                    ebayStatus.innerHTML = `
                        ‚úÖ <strong>eBay Connected:</strong> Ready to create listings as ${accountInfo.accountInfo.sellerAccount}
                    `;
                    createListingBtn.disabled = false;
                } else {
                    throw new Error('eBay account not connected');
                }
            } catch (error) {
                console.log('eBay not connected:', error.message);
                ebayStatus.className = 'ebay-status disconnected';
                ebayStatus.innerHTML = `
                    ‚ö†Ô∏è <strong>eBay Not Connected:</strong> You need to connect your eBay account first.
                    <a href="/ebay-connect.html" style="color: #ef6c00; text-decoration: underline;">Connect Now</a>
                `;
                createListingBtn.disabled = true;
            }
        }


        
        // Generate listing data from scan
        async function generateListingData() {
            const analysis = scanData.analysis || {};
            const editedData = scanData.editedData || {};
            
            // Use edited data if available, fallback to analysis
            const category = editedData.category || analysis.category || 'Unknown';
            const brand = editedData.brand || analysis.brand || 'Unknown';
            const model = editedData.model || analysis.model || 'Unknown';
            const condition = editedData.condition || analysis.condition?.rating || 'used';
            const description = editedData.description || generateDescription(analysis);
            const suggestedPrice = editedData.price || analysis.resale?.estimated_value || 9.99;
            
            // Generate optimized title
            const title = generateTitle(brand, model, category);
            
            // Get all photos (final photos if available, otherwise scan + listing photos)
            const allPhotos = scanData.finalPhotos || 
                             [...(scanData.images || []), ...(scanData.listingPhotos || [])];
            
            listingData = {
                title: title,
                description: description,
                category: category,
                brand: brand,
                model: model,
                condition: condition,
                photos: allPhotos,
                pricing: {
                    starting: Math.max(0.99, suggestedPrice * 0.8),
                    buyItNow: suggestedPrice,
                    acceptOffers: true
                },
                shipping: {
                    type: 'calculated',
                    cost: calculateShippingCost(category)
                }
            };
            
            console.log('Generated listing data:', listingData);
        }

        // Display listing preview
        function displayListingPreview() {
            // Set title and basic info
            listingTitle.textContent = listingData.title;
            listingPrice.textContent = `${listingData.pricing.buyItNow.toFixed(2)}`;
            listingCondition.textContent = formatCondition(listingData.condition);
            listingCategory.textContent = listingData.category;
            listingBrand.textContent = listingData.brand;
            listingDescription.textContent = listingData.description;
            
            // Set form values
            startingPrice.value = listingData.pricing.starting.toFixed(2);
            buyItNowPrice.value = listingData.pricing.buyItNow.toFixed(2);
            acceptOffers.checked = listingData.pricing.acceptOffers;
            
            // Display photos
            displayPhotos();
            
            // Update calculations
            updateCalculations();
        }

        // Display photos
        function displayPhotos() {
            if (!listingData.photos || listingData.photos.length === 0) {
                mainPhoto.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiPk5vIFBob3RvPC90ZXh0Pgo8L3N2Zz4K';
                photoThumbnails.innerHTML = '<p style="color: #666; text-align: center;">No photos available</p>';
                return;
            }
            
            // Set main photo
            mainPhoto.src = `data:image/jpeg;base64,${listingData.photos[0]}`;
            
            // Create thumbnails
            photoThumbnails.innerHTML = '';
            listingData.photos.forEach((base64, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.className = 'thumbnail';
                thumbnail.src = `data:image/jpeg;base64,${base64}`;
                thumbnail.alt = `Photo ${index + 1}`;
                
                if (index === 0) thumbnail.classList.add('active');
                
                thumbnail.addEventListener('click', () => {
                    mainPhoto.src = thumbnail.src;
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumbnail.classList.add('active');
                });
                
                photoThumbnails.appendChild(thumbnail);
            });
        }

        // Setup form handlers
        function setupFormHandlers() {
            // Price change handlers
            startingPrice.addEventListener('input', updateCalculations);
            buyItNowPrice.addEventListener('input', updateCalculations);
            
            // Shipping option handlers
            document.querySelectorAll('.shipping-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.shipping-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    updateCalculations();
                });
            });
        }

        // Update profit calculations
        function updateCalculations() {
            const price = parseFloat(startingPrice.value) || 0;
            const shippingCost = listingData.shipping.cost || 8;
            const ebayFees = price * 0.1325; // 13.25% eBay fees
            const netProfit = price - ebayFees - (getSelectedShippingType() === 'free' ? shippingCost : 0);
            
            document.getElementById('calcStartPrice').textContent = `${price.toFixed(2)}`;
            document.getElementById('calcEbayFees').textContent = `${ebayFees.toFixed(2)}`;
            document.getElementById('calcShipping').textContent = getSelectedShippingType() === 'free' ? `${shippingCost.toFixed(2)}` : '$0.00';
            document.getElementById('calcNetProfit').textContent = `${Math.max(0, netProfit).toFixed(2)}`;
            
            // Update main price display
            listingPrice.textContent = `${price.toFixed(2)}`;
        }

        // Get selected shipping type
        function getSelectedShippingType() {
            const selected = document.querySelector('.shipping-option.selected');
            return selected ? selected.dataset.service : 'calculated';
        }

        // Create eBay listing using secure backend
        createListingBtn.addEventListener('click', async () => {
            try {
                showLoading(true, 'Creating eBay listing...');
                
                // Prepare listing data for secure backend
                const ebayListingData = {
                    scanId: currentScanId,
                    title: listingData.title,
                    description: listingData.description,
                    category: listingData.category,
                    condition: listingData.condition,
                    photos: listingData.photos,
                    pricing: {
                        startingPrice: parseFloat(startingPrice.value),
                        buyItNowPrice: parseFloat(buyItNowPrice.value),
                        acceptOffers: acceptOffers.checked
                    },
                    shipping: {
                        type: getSelectedShippingType(),
                        cost: listingData.shipping.cost
                    },
                    duration: document.getElementById('duration').value,
                    returnPolicy: document.getElementById('returnPolicy').value
                };
                
                console.log('Creating eBay listing with secure backend:', ebayListingData);
                
                // Call secure backend to create listing
                const result = await secureSDK.createEbayListing(ebayListingData);
                
                if (result.success) {
                    // Update scan status locally (backend also updates it)
                    try {
                        await db.collection('users')
                            .doc(currentUser.uid)
                            .collection('scans')
                            .doc(currentScanId)
                            .update({
                                status: 'listed',
                                ebayListingId: result.listingId,
                                ebayUrl: result.url,
                                listedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    } catch (updateError) {
                        console.warn('Local scan update failed:', updateError);
                        // Don't fail the whole process if local update fails
                    }
                    
                    showSuccess(`üéâ Listing created successfully! <a href="${result.url}" target="_blank" style="color: #2e7d32; text-decoration: underline;">View on eBay</a>`);
                    
                    // Redirect to dashboard after delay
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 3000);
                    
                } else {
                    throw new Error(result.error || 'Listing creation failed');
                }
                
            } catch (error) {
                console.error('Error creating eBay listing:', error);
                
                // Handle specific error types
                if (error.message.includes('authentication') || error.message.includes('token')) {
                    showError('eBay authentication error. Please reconnect your eBay account.');
                } else if (error.message.includes('policy')) {
                    showError('eBay seller policies not set up. Please configure your policies on eBay.com');
                } else if (error.message.includes('requiresReauth')) {
                    showError('eBay authentication expired. <a href="/ebay-connect.html" style="color: #c62828;">Reconnect your account</a>');
                } else {
                    showError('Failed to create listing: ' + error.message);
                }
                
            } finally {
                showLoading(false);
            }
        });

        // Save draft
        async function saveDraft() {
            try {
                const draftData = {
                    title: listingData.title,
                    description: listingData.description,
                    pricing: {
                        startingPrice: parseFloat(startingPrice.value),
                        buyItNowPrice: parseFloat(buyItNowPrice.value),
                        acceptOffers: acceptOffers.checked
                    },
                    shipping: {
                        type: getSelectedShippingType()
                    },
                    duration: document.getElementById('duration').value,
                    returnPolicy: document.getElementById('returnPolicy').value
                };
                
                await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('scans')
                    .doc(currentScanId)
                    .update({
                        draftListing: draftData,
                        status: 'draft_ready',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showSuccess('Draft saved successfully!');
                
            } catch (error) {
                console.error('Error saving draft:', error);
                showError('Failed to save draft: ' + error.message);
            }
        }

        // Go back to photos
        function goBack() {
            window.location.href = `/photo-upload.html?scanId=${currentScanId}`;
        }

        // Utility functions
        function generateTitle(brand, model, category) {
            const parts = [];
            
            if (brand && brand !== 'Unknown') {
                parts.push(brand);
            }
            
            if (model && model !== 'Unknown') {
                parts.push(model);
            }
            
            parts.push(category);
            
            // Add condition hint
            parts.push('- Used');
            
            return parts.join(' ').substring(0, 80); // eBay title limit
        }

        function generateDescription(analysis) {
            let description = '';
            
            if (analysis.condition?.description) {
                description += analysis.condition.description + '\n\n';
            }
            
            if (analysis.keyFeatures && analysis.keyFeatures.length > 0) {
                description += 'Features:\n';
                analysis.keyFeatures.forEach(feature => {
                    description += `‚Ä¢ ${feature}\n`;
                });
                description += '\n';
            }
            
            description += 'Item sold as-is. Please review all photos carefully before bidding.\n\n';
            description += 'Found item - selling to give it a new home! Questions welcome.';
            
            return description;
        }

        function formatCondition(condition) {
            const conditionMap = {
                'new': 'New',
                'like_new': 'Like New',
                'excellent': 'Excellent',
                'very_good': 'Very Good',
                'good': 'Good',
                'acceptable': 'Acceptable',
                'for_parts': 'For Parts/Not Working'
            };
            
            return conditionMap[condition] || 'Used';
        }

        function calculateShippingCost(category) {
            const shippingRates = {
                'electronics': 12,
                'clothing': 6,
                'furniture': 25,
                'tools': 15,
                'automotive': 20,
                'sporting goods': 18,
                'books': 4,
                'toys': 8,
                'jewelry': 5,
                'collectibles': 10
            };
            
            return shippingRates[category?.toLowerCase()] || 8;
        }

        function showLoading(show, text = 'Loading...') {
            loadingState.style.display = show ? 'block' : 'none';
            if (text) document.getElementById('loadingText').textContent = text;
        }

        function showError(message) {
            errorMessage.innerHTML = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        function showSuccess(message) {
            successMessage.innerHTML = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Auto-hide after 5 seconds unless it contains a link
            if (!message.includes('<a')) {
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Secure listing preview page loaded');
        });
    </script>
</body>
</html>