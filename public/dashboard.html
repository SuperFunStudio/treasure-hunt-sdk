<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunter - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 1;
            padding: 10px 0;
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 20px;
            text-decoration: none;
            color: #333;
            transition: background 0.2s;
        }
        
        .dropdown-item:hover {
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .welcome-section h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .welcome-section p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 16px;
        }
        
        .actions-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .action-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .action-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .action-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .action-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .ebay-status {
            margin-bottom: 20px;
        }
        
        .status-connected {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-disconnected {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recent-scans {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .recent-scans h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .scan-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .scan-item:hover {
            background: #f5f5f5;
        }
        
        .scan-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .scan-details {
            flex: 1;
        }
        
        .scan-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .scan-meta {
            font-size: 14px;
            color: #666;
        }
        
        .scan-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-draft {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .status-listed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-sold {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            display: none;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-content {
                padding: 0 15px;
            }
            
            .container {
                padding: 20px 15px;
            }
            
            .welcome-section {
                padding: 30px 20px;
            }
            
            .welcome-section h1 {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .actions-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üè¥‚Äç‚ò†Ô∏è Treasure Hunter
            </div>
            
            <div class="user-menu">
                <div class="dropdown">
                    <div class="user-avatar" id="userAvatar">
                        TH
                    </div>
                    <div class="dropdown-content">
                        <a href="/profile.html" class="dropdown-item">üë§ Profile</a>
                        <a href="/scan-editor.html" class="dropdown-item">üì∏ New Scan</a>
                        <a href="#" class="dropdown-item" id="signoutBtn">üö™ Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Success/Error Messages -->
        <div id="successMessage" class="success"></div>
        <div id="errorMessage" class="error"></div>

        <!-- Welcome Section -->
        <div class="welcome-section">
            <h1 id="welcomeMessage">Welcome back, Treasure Hunter!</h1>
            <p>Ready to discover your next treasure and turn it into profit?</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">üì±</div>
                <div class="stat-value" id="totalScans">0</div>
                <div class="stat-label">Total Scans</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalEarnings">$0</div>
                <div class="stat-label">Total Earnings</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìç</div>
                <div class="stat-value" id="pinsCreated">0</div>
                <div class="stat-label">Pins Created</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value" id="communityRating">0.0</div>
                <div class="stat-label">Community Rating</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
            <!-- Scan Item -->
            <div class="action-card">
                <div class="action-icon">üì∏</div>
                <h3>Scan New Item</h3>
                <p>Take photos of an item to get AI analysis and market pricing</p>
                <button class="action-btn" onclick="window.location.href='/scan-editor.html'">
                    Start Scanning
                </button>
            </div>

            <div class="action-card" id="locationSetupCard" style="border-left: 4px solid #ff9800; display: none;">
    <div class="action-icon">üìç</div>
    <h3>Set Up Shipping Location</h3>
    <p>Required for eBay listings - set up once, use everywhere</p>
    <button class="action-btn secondary" onclick="window.location.href='/shipping-locations.html'">
        Set Up Location
    </button>
</div>
            
            <!-- eBay Connection -->
            <div class="action-card">
                <div class="action-icon">üõí</div>
                <h3>eBay Integration</h3>
                <div id="ebayStatusContainer">
                    <div class="status-disconnected">
                        <span>‚ö†Ô∏è</span>
                        <span>eBay account not connected</span>
                    </div>
                </div>
                <p>Connect your eBay account to create listings directly from scans</p>
                <button class="action-btn secondary" id="ebayConnectBtn">
                    Connect eBay Account
                </button>
            </div>
            
            <!-- View History -->
            <div class="action-card">
                <div class="action-icon">üìã</div>
                <h3>Scan History</h3>
                <p>Review your previous scans, drafts, and listings</p>
                <button class="action-btn secondary" onclick="scrollToRecentScans()">
                    View All Scans
                </button>
            </div>
        </div>

        <!-- Recent Scans -->
        <div class="recent-scans">
            <h3>Recent Scans</h3>
            <div id="recentScansContainer">
                <div class="loading">
                    Loading your recent scans...
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // üéØ API Configuration
        const API_CONFIG = {
            projectId: 'treasurehunter-sdk', // Replace with your actual project ID
            region: 'us-central1', // Replace with your functions region if different
            
            get baseUrl() {
                return `https://${this.region}-${this.projectId}.cloudfunctions.net`;
            },
            
            get ebayAccountInfoUrl() {
                return `${this.baseUrl}/ebayAccountInfo`;
            },
            
            get ebayAuthUrl() {
                return `${this.baseUrl}/ebayAuth`;
            }
        };

        const API_BASE_URL = API_CONFIG.baseUrl;

        console.log('üîß API Configuration loaded:', {
            baseUrl: API_CONFIG.baseUrl,
            ebayAccountInfo: API_CONFIG.ebayAccountInfoUrl,
            ebayAuth: API_CONFIG.ebayAuthUrl
        });

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDymYwo7NUAu7lhoPfS9KLQmckvVgky7PU",
            authDomain: "treasurehunter-sdk.firebaseapp.com",
            projectId: "treasurehunter-sdk",
            storageBucket: "treasurehunter-sdk.firebasestorage.app",
            messagingSenderId: "328804663359",
            appId: "1:328804663359:web:eb124f150c4853c123788a",
            measurementId: "G-YNJ58GLX3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = {};

        // üéØ Enhanced eBay Account Info Loading
        async function loadEbayAccountInfo() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('‚ö†Ô∏è No authenticated user for eBay account info');
                    return;
                }

                console.log('üîÑ Loading eBay account info...');
                
                const response = await fetch(API_CONFIG.ebayAccountInfoUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${await user.getIdToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° eBay account info response:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ eBay account info loaded:', data.accountInfo);
                    displayEbayAccountInfo(data.accountInfo);
                    return data.accountInfo;
                } else if (response.status === 400) {
                    console.log('üì≠ eBay account not connected');
                    displayEbayNotConnected();
                    return null;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading eBay account info:', error);
                displayEbayError(error.message);
                return null;
            }
        }

        // üéØ Enhanced eBay Account Display
        function displayEbayAccountInfo(accountInfo) {
            const dashboardContainer = document.getElementById('ebayStatusContainer');
            if (dashboardContainer) {
                dashboardContainer.innerHTML = `
                    <div class="status-connected">
                        <span>‚úÖ</span>
                        <div>
                            <strong>Connected as ${accountInfo.displayName || accountInfo.username}</strong>
                            <br>
                            <small>@${accountInfo.username} ‚Ä¢ ${accountInfo.sellerAccount}</small>
                            ${accountInfo.canList ? 
                                '<br><small style="color: #2e7d32;">‚úÖ Can create listings</small>' : 
                                '<br><small style="color: #f57c00;">‚ö†Ô∏è Basic account - limited listing capability</small>'
                            }
                        </div>
                    </div>
                `;
            }

            const ebayConnectBtn = document.getElementById('ebayConnectBtn');
            if (ebayConnectBtn) {
                ebayConnectBtn.textContent = 'Manage eBay Account';
                ebayConnectBtn.className = 'action-btn secondary';
                ebayConnectBtn.onclick = () => window.location.href = '/profile.html#ebay';
            }
        }

        function displayEbayNotConnected() {
            const dashboardContainer = document.getElementById('ebayStatusContainer');
            if (dashboardContainer) {
                dashboardContainer.innerHTML = `
                    <div class="status-disconnected">
                        <span>‚ö†Ô∏è</span>
                        <span>eBay account not connected</span>
                    </div>
                `;
            }

            const ebayConnectBtn = document.getElementById('ebayConnectBtn');
            if (ebayConnectBtn) {
                ebayConnectBtn.textContent = 'Connect eBay Account';
                ebayConnectBtn.className = 'action-btn secondary';
                ebayConnectBtn.onclick = connectEbay;
            }
        }

        function displayEbayError(errorMessage) {
            console.error('eBay connection error:', errorMessage);
            
            const dashboardContainer = document.getElementById('ebayStatusContainer');
            if (dashboardContainer) {
                dashboardContainer.innerHTML = `
                    <div class="status-disconnected">
                        <span>‚ùå</span>
                        <span>eBay connection error</span>
                    </div>
                `;
            }
        }

        function connectEbay() {
            console.log('üîó Redirecting to eBay connection...');
            window.location.href = '/ebay-connect.html';
        }

        // üéØ eBay Connection Success Handler
        async function handleEbayConnectionSuccess(data) {
            console.log('üéâ eBay connection successful:', data);
            
            try {
                const accountInfo = data.accountInfo;
                const successMessage = `Successfully connected to eBay as ${accountInfo.displayName || accountInfo.username}!`;
                
                showSuccess(successMessage);
                displayEbayAccountInfo(accountInfo);
                
                if (typeof userData !== 'undefined') {
                    userData.ebay = {
                        isConnected: true,
                        username: accountInfo.username,
                        displayName: accountInfo.displayName,
                        sellerAccount: accountInfo.sellerAccount,
                        canList: accountInfo.canList,
                        connectedAt: accountInfo.connectedAt,
                        environment: data.environment
                    };
                    
                    updateUserInterface();
                }
                
                setTimeout(async () => {
                    console.log('üîÑ Refreshing page data after eBay connection...');
                    await loadUserData();
                    await loadEbayAccountInfo();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error handling eBay connection success:', error);
                showError('eBay connected successfully, but there was an error updating the display. Please refresh the page.');
            }
        }

        function handleEbayConnectionError(error) {
            console.error('‚ùå eBay connection failed:', error);
            
            let errorMessage = 'Failed to connect to eBay. ';
            
            if (error.message) {
                if (error.message.includes('user_cancelled')) {
                    errorMessage += 'You cancelled the connection process.';
                } else if (error.message.includes('access_denied')) {
                    errorMessage += 'Access was denied. Please try again and approve the connection.';
                } else if (error.message.includes('invalid_request')) {
                    errorMessage += 'There was a problem with the connection request. Please try again.';
                } else {
                    errorMessage += error.message;
                }
            } else {
                errorMessage += 'Please try again or contact support if the problem persists.';
            }
            
            showError(errorMessage);
            displayEbayNotConnected();
        }

        function initializeEbayConnectionHandling() {
            const urlParams = new URLSearchParams(window.location.search);
            const ebaySuccess = urlParams.get('ebay_success');
            const ebayError = urlParams.get('ebay_error');
            
            if (ebaySuccess === 'true') {
                console.log('üîç Detected eBay OAuth success return');
                
                const connectionData = localStorage.getItem('ebay_connection_data');
                
                if (connectionData) {
                    try {
                        const data = JSON.parse(connectionData);
                        handleEbayConnectionSuccess(data);
                        localStorage.removeItem('ebay_connection_data');
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    } catch (parseError) {
                        console.error('Error parsing eBay connection data:', parseError);
                        showError('eBay connection was successful, but there was an error processing the data. Please refresh the page.');
                    }
                } else {
                    console.warn('eBay success detected but no connection data found');
                    showSuccess('eBay account connected successfully!');
                    setTimeout(loadEbayAccountInfo, 1000);
                }
            }
            
            if (ebayError) {
                console.log('üîç Detected eBay OAuth error return');
                handleEbayConnectionError({ message: ebayError });
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // Check authentication state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                console.log('User authenticated on dashboard:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                });
                
                await loadUserData();
                await loadDashboardData();
                
                setTimeout(() => {
                    initializeEbayConnectionHandling();
                }, 500);
            } else {
                window.location.href = '/signin.html';
            }
        });

        // Load user data from Firestore
        async function loadUserData() {
            try {
                const firebaseUID = currentUser.uid;
                console.log('Loading dashboard data for UID:', firebaseUID);
                
                const userDoc = await db.collection('users').doc(firebaseUID).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('‚úÖ Dashboard user data loaded successfully');
                    updateUserInterface();
                } else {
                    console.error('‚ùå User document not found for UID:', firebaseUID);
                    showUserNotFoundError();
                }
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
                showLoadingError(error);
            }
        }

        // Update UI with user data
        function updateUserInterface() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            const userName = userData.profile || currentUser.displayName || 'Treasure Hunter';
            welcomeMessage.textContent = `Welcome back, ${userName}!`;
            
            const userAvatar = document.getElementById('userAvatar');
            const initials = getInitials(userName);
            userAvatar.textContent = initials;

            const hasLocations = userData.shippingLocations && userData.shippingLocations.length > 0;
const locationSetupCard = document.getElementById('locationSetupCard');
if (locationSetupCard) {
    locationSetupCard.style.display = hasLocations ? 'none' : 'block';
}
            
            const stats = userData.stats || {};
            document.getElementById('totalScans').textContent = stats.totalScans || 0;
            document.getElementById('totalEarnings').textContent = `$${(stats.totalEarnings || 0).toFixed(2)}`;
            document.getElementById('pinsCreated').textContent = stats.pinsCreated || 0;
            document.getElementById('communityRating').textContent = (userData.verification?.communityRating || 0).toFixed(1);
            
            loadEbayAccountInfo();
        }

        // Load dashboard data
        async function loadDashboardData() {
            await loadRecentScans();
            await loadEbayAccountInfo();
        }

        // Load recent scans
        async function loadRecentScans() {
            const container = document.getElementById('recentScansContainer');
            
            try {
                console.log('üîç Loading recent scans for user:', currentUser.uid);
                
                const testQuery = await db.collection('scanned_items')
                    .where('uid', '==', currentUser.uid)
                    .limit(5)
                    .get();
                
                console.log('‚úÖ Basic query successful, found', testQuery.size, 'documents');
                
                if (testQuery.empty) {
                    console.log('üì≠ No scans found for this user');
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì±</div>
                            <p>No scans yet. Start by scanning your first item!</p>
                            <button class="action-btn" onclick="window.location.href='/scan-editor.html'" style="margin-top: 15px; max-width: 200px;">
                                Scan First Item
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let scansQuery;
                try {
                    console.log('üìä Attempting ordered query...');
                    scansQuery = await db.collection('scanned_items')
                        .where('uid', '==', currentUser.uid)
                        .orderBy('timestamp', 'desc')
                        .limit(5)
                        .get();
                } catch (orderError) {
                    console.warn('‚ö†Ô∏è Ordered query failed, using unordered:', orderError.message);
                    scansQuery = testQuery;
                }
                
                console.log('‚úÖ Final query successful, processing', scansQuery.size, 'documents');
                
                let scansHtml = '';
                scansQuery.forEach((doc) => {
                    const scan = doc.data();
                    console.log('üìÑ Processing scan:', doc.id, scan);
                    const scanItem = createScanItem(doc.id, scan);
                    scansHtml += scanItem;
                });
                
                container.innerHTML = scansHtml;
                
            } catch (error) {
                console.error('‚ùå Error loading recent scans:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p><strong>Debug Info:</strong></p>
                        <p>Error: ${error.message}</p>
                        <p>User ID: ${currentUser.uid}</p>
                        <p>Collection: scanned_items</p>
                        <button class="action-btn" onclick="testFirestoreAccess()" style="margin-top: 15px; max-width: 200px;">
                            Test Firestore Access
                        </button>
                    </div>
                `;
            }
        }

        // Test Firestore access
        async function testFirestoreAccess() {
            console.log('üß™ Starting Firestore access test...');
            const container = document.getElementById('recentScansContainer');
            
            try {
                console.log('Test 1: Authentication');
                if (!currentUser) {
                    throw new Error('No authenticated user');
                }
                console.log('‚úÖ User authenticated:', currentUser.uid);
                
                console.log('Test 2: Basic Firestore read');
                const basicTest = await db.collection('scanned_items').limit(1).get();
                console.log('‚úÖ Basic Firestore read successful');
                
                console.log('Test 3: Check document count');
                const allDocs = await db.collection('scanned_items').get();
                console.log(`‚úÖ Found ${allDocs.size} total documents in scanned_items`);
                
                console.log('Test 4: Check user documents');
                const userDocs = await db.collection('scanned_items')
                    .where('uid', '==', currentUser.uid)
                    .get();
                console.log(`‚úÖ Found ${userDocs.size} documents for user ${currentUser.uid}`);
                
                console.log('Test 5: Analyzing UIDs in collection');
                const uidCounts = {};
                allDocs.forEach(doc => {
                    const uid = doc.data().uid;
                    uidCounts[uid] = (uidCounts[uid] || 0) + 1;
                });
                console.log('UID distribution:', uidCounts);
                
                if (allDocs.size > 0) {
                    const sampleDoc = allDocs.docs[0];
                    console.log('Sample document structure:', sampleDoc.id, sampleDoc.data());
                }
                
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>Firestore Test Results</h3>
                        <p><strong>User ID:</strong> ${currentUser.uid}</p>
                        <p><strong>Total Documents:</strong> ${allDocs.size}</p>
                        <p><strong>User Documents:</strong> ${userDocs.size}</p>
                        <p><strong>UIDs Found:</strong> ${Object.keys(uidCounts).join(', ')}</p>
                        <p>Check browser console for detailed logs</p>
                        <button class="action-btn" onclick="loadRecentScans()" style="margin-top: 15px;">
                            Try Loading Scans Again
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Firestore test failed:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Firestore Test Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Code:</strong> ${error.code || 'Unknown'}</p>
                        <p>Check browser console and Firebase rules</p>
                    </div>
                `;
            }
        }

        // Create scan item HTML
        function createScanItem(scanId, scan) {
            console.log('üèóÔ∏è Creating scan item for:', scanId, scan);
            
            const analysis = scan.analysis || scan;
            const category = analysis.category || scan.category || 'Unknown Item';
            const brand = (analysis.brand && analysis.brand !== 'Unknown') ? analysis.brand : '';
            const title = brand ? `${brand} ${category}` : category;
            
            let createdAt = 'Recently';
            if (scan.timestamp) {
                try {
                    const date = typeof scan.timestamp === 'string' 
                        ? new Date(scan.timestamp) 
                        : scan.timestamp.toDate ? scan.timestamp.toDate() : new Date(scan.timestamp);
                    createdAt = date.toLocaleDateString();
                } catch (e) {
                    console.warn('Failed to parse timestamp:', scan.timestamp);
                }
            } else if (scan.createdAt) {
                try {
                    createdAt = scan.createdAt.toDate ? 
                        scan.createdAt.toDate().toLocaleDateString() : 
                        new Date(scan.createdAt).toLocaleDateString();
                } catch (e) {
                    console.warn('Failed to parse createdAt:', scan.createdAt);
                }
            }
            
            const status = scan.status || 'completed';
            const statusClass = `status-${status}`;
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);
            
            const confidence = analysis.confidence || analysis.confidence_rating || scan.confidence || 'N/A';
            const categoryIcon = getCategoryIcon(category);
            
            return `
                <div class="scan-item" onclick="openScan('${scanId}')">
                    <div class="scan-image">
                        ${categoryIcon}
                    </div>
                    <div class="scan-details">
                        <div class="scan-title">${title}</div>
                        <div class="scan-meta">${createdAt} ‚Ä¢ Confidence: ${confidence}/10</div>
                    </div>
                    <div class="scan-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
            `;
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'electronics': 'üì±',
                'furniture': 'ü™ë',
                'clothing': 'üëï',
                'tools': 'üîß',
                'books': 'üìö',
                'toys': 'üß∏',
                'jewelry': 'üíç',
                'automotive': 'üöó',
                'sporting goods': '‚öΩ',
                'home & garden': 'üè°'
            };
            
            return icons[category?.toLowerCase()] || 'üì¶';
        }

        // Open scan for editing
        function openScan(scanId) {
            window.location.href = `/scan-editor.html?scanId=${scanId}`;
        }

        // Scroll to recent scans
        function scrollToRecentScans() {
            document.querySelector('.recent-scans').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Update last active timestamp
        async function updateLastActive() {
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    'metadata.lastActiveAt': firebase.firestore.FieldValue.serverTimestamp(),
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating last active:', error);
            }
        }

        // Error handling functions
        function showUserNotFoundError() {
            showError('User profile not found. Please try signing out and back in.');
        }

        function showLoadingError(error) {
            showError(`Failed to load dashboard data: ${error.message}`);
        }

        // Utility functions
        function showSuccess(message) {
            console.log('‚úÖ', message);
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                successDiv.scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 5000);
            } else {
                createTemporaryMessage(message, 'success');
            }
        }

        function showError(message) {
            console.error('‚ùå', message);
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                createTemporaryMessage(message, 'error');
            }
        }

        function createTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, type === 'success' ? 5000 : 8000);
        }

        function getInitials(name) {
            if (!name) return 'TH';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // Sign out
        document.getElementById('signoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await auth.signOut();
                window.location.href = '/signin.html';
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        // Auto-refresh data every 30 seconds
        setInterval(async () => {
            if (currentUser) {
                await updateLastActive();
            }
        }, 30000);

        // Initialize eBay connection handling on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ Dashboard initialized');
            initializeEbayConnectionHandling();
        });
    </script>
</body>
</html>