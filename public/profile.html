<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunter - Profile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .nav-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .profile-email {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .profile-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .section-title {
            flex: 1;
        }
        
        .section-title h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .section-title p {
            color: #666;
            font-size: 14px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input:disabled {
            background: #f5f5f5;
            color: #666;
        }
        
        .ebay-connection {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .ebay-connected {
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        .ebay-disconnected {
            background: #ffebee;
            border: 2px solid #f44336;
        }
        
        .ebay-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .status-icon {
            font-size: 24px;
        }
        
        .status-text h4 {
            margin-bottom: 5px;
        }
        
        .status-text p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        
        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
            display: none;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f44336;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .danger-zone {
            border-top: 2px solid #f44336;
            padding-top: 20px;
            margin-top: 30px;
        }
        
        .danger-zone h4 {
            color: #f44336;
            margin-bottom: 15px;
        }
        
        .security-section {
            border-left: 4px solid #2196f3;
            background: #f3f8ff;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .profile-header {
                padding: 30px 20px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <a href="/dashboard.html" class="logo">
                üè¥‚Äç‚ò†Ô∏è Treasure Hunter
            </a>
            
            <div class="nav-actions">
                <a href="/dashboard.html" class="nav-btn">üè† Dashboard</a>
                <a href="/scan-editor.html" class="nav-btn">üì∏ New Scan</a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">TH</div>
            <div class="profile-name" id="profileName">Loading...</div>
            <div class="profile-email" id="profileEmail">Loading...</div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalScansCount">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalEarningsAmount">$0</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="communityRatingValue">0.0</div>
                    <div class="stat-label">Community Rating</div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="successMessage" class="success"></div>
        <div id="errorMessage" class="error"></div>

        <!-- Personal Information -->
        <div class="profile-section">
            <div class="section-header">
                <div class="section-icon">üë§</div>
                <div class="section-title">
                    <h3>Personal Information</h3>
                    <p>Update your basic profile information</p>
                </div>
            </div>

            <form id="profileForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="displayName">Display Name</label>
                        <input type="text" id="displayName" placeholder="Your name or nickname">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="City, State">
                    </div>
                    
                    <div class="form-group">
                        <label for="timezone">Timezone</label>
                        <select id="timezone">
                            <option value="EST">Eastern (EST)</option>
                            <option value="CST">Central (CST)</option>
                            <option value="MST">Mountain (MST)</option>
                            <option value="PST">Pacific (PST)</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        üíæ Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- eBay Integration -->
        <div class="profile-section" id="ebaySection">
            <div class="section-header">
                <div class="section-icon">üõí</div>
                <div class="section-title">
                    <h3>eBay Integration</h3>
                    <p>Connect your eBay account to create listings directly</p>
                </div>
            </div>

            <div id="ebayConnectionStatus">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Security Settings -->
        <div class="profile-section">
            <div class="section-header">
                <div class="section-icon">üîí</div>
                <div class="section-title">
                    <h3>Security & Privacy</h3>
                    <p>Manage your account security settings</p>
                </div>
            </div>

            <div class="security-section">
                <h4 style="margin-bottom: 15px;">Password & Authentication</h4>
                
                <div class="form-group">
                    <label>Last Password Change</label>
                    <input type="text" id="lastPasswordChange" disabled value="Unknown">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="changePassword()">
                        üîë Change Password
                    </button>
                    <button class="btn btn-secondary" onclick="enableTwoFactor()">
                        üõ°Ô∏è Enable 2FA
                    </button>
                </div>
            </div>

            <div class="danger-zone">
                <h4>‚ö†Ô∏è Danger Zone</h4>
                <p style="margin-bottom: 15px;">These actions cannot be undone. Please be certain.</p>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        üóëÔ∏è Delete Account
                    </button>
                </div>
            </div>
        </div>


<div class="profile-section">
    <div class="section-header">
        <div class="section-icon">üìç</div>
        <div class="section-title">
            <h3>Shipping Locations</h3>
            <p>Manage your shipping addresses for marketplace listings</p>
        </div>
    </div>

    <div id="shippingLocationsPreview">
        <p style="color: #666; margin-bottom: 20px;">No shipping locations configured</p>
    </div>

    <div class="action-buttons">
        <button class="btn btn-primary" onclick="window.location.href='/shipping-locations.html'">
            Manage Locations
        </button>
    </div>
</div>

        <!-- Beta Feedback -->
        <div class="profile-section">
            <div class="section-header">
                <div class="section-icon">üí¨</div>
                <div class="section-title">
                    <h3>Beta Feedback</h3>
                    <p>Help us improve Treasure Hunter</p>
                </div>
            </div>

            <form id="feedbackForm">
                <div class="form-group">
                    <label for="feedback">Share your feedback</label>
                    <textarea id="feedback" rows="4" placeholder="Tell us about your experience, bugs you've found, or features you'd like to see..."></textarea>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">
                        üì© Send Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // üéØ API Configuration
        const API_CONFIG = {
            projectId: 'treasurehunter-sdk', // Replace with your actual project ID
            region: 'us-central1', // Replace with your functions region if different
            
            get baseUrl() {
                return `https://${this.region}-${this.projectId}.cloudfunctions.net`;
            },
            
            get ebayAccountInfoUrl() {
                return `${this.baseUrl}/ebayAccountInfo`;
            },
            
            get ebayAuthUrl() {
                return `${this.baseUrl}/ebayAuth`;
            }
        };

        const API_BASE_URL = API_CONFIG.baseUrl;

        console.log('üîß API Configuration loaded:', {
            baseUrl: API_CONFIG.baseUrl,
            ebayAccountInfo: API_CONFIG.ebayAccountInfoUrl,
            ebayAuth: API_CONFIG.ebayAuthUrl
        });

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDymYwo7NUAu7lhoPfS9KLQmckvVgky7PU",
            authDomain: "treasurehunter-sdk.firebaseapp.com",
            projectId: "treasurehunter-sdk",
            storageBucket: "treasurehunter-sdk.firebasestorage.app",
            messagingSenderId: "328804663359",
            appId: "1:328804663359:web:eb124f150c4853c123788a",
            measurementId: "G-YNJ58GLX3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = {};
        let originalData = null;

        // üéØ Enhanced eBay Account Info Loading
        async function loadEbayAccountInfo() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('‚ö†Ô∏è No authenticated user for eBay account info');
                    return;
                }

                console.log('üîÑ Loading eBay account info...');
                
                const response = await fetch(API_CONFIG.ebayAccountInfoUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${await user.getIdToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° eBay account info response:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ eBay account info loaded:', data.accountInfo);
                    displayEbayAccountInfo(data.accountInfo);
                    return data.accountInfo;
                } else if (response.status === 400) {
                    console.log('üì≠ eBay account not connected');
                    displayEbayNotConnected();
                    return null;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading eBay account info:', error);
                displayEbayError(error.message);
                return null;
            }
        }

        // üéØ Enhanced eBay Account Display FOR PROFILE PAGE
        function displayEbayAccountInfo(accountInfo) {
            const profileContainer = document.getElementById('ebayConnectionStatus');
            if (profileContainer) {
                profileContainer.innerHTML = `
                    <div class="ebay-connection ebay-connected">
                        <div class="ebay-status">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-text">
                                <h4>eBay Account Connected</h4>
                                <p><strong>${accountInfo.displayName || accountInfo.username}</strong> (@${accountInfo.username})</p>
                                <p>Account Type: ${accountInfo.sellerAccount}</p>
                                ${accountInfo.email ? `<p>Email: ${accountInfo.email}</p>` : ''}
                                <p>Connected: ${new Date(accountInfo.connectedAt).toLocaleDateString()}</p>
                                <p>Environment: ${accountInfo.environment === 'sandbox' ? 'üß™ Sandbox' : 'üåê Production'}</p>
                                ${accountInfo.canList ? 
                                    '<p style="color: #2e7d32;">‚úÖ Listing capability verified</p>' : 
                                    '<p style="color: #f57c00;">‚ö†Ô∏è Basic account - limited listing capability</p>'
                                }
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="refreshEbayConnection()">
                                üîÑ Refresh Connection
                            </button>
                            <button class="btn btn-danger" onclick="disconnectEbay()">
                                üîå Disconnect eBay
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function displayEbayNotConnected() {
            const profileContainer = document.getElementById('ebayConnectionStatus');
            if (profileContainer) {
                profileContainer.innerHTML = `
                    <div class="ebay-connection ebay-disconnected">
                        <div class="ebay-status">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-text">
                                <h4>eBay Account Not Connected</h4>
                                <p>Connect your eBay account to create listings directly from scans</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="connectEbay()">
                                üîó Connect eBay Account
                            </button>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
                            <strong>Benefits of connecting eBay:</strong>
                            <ul style="margin: 10px 0 0 20px;">
                                <li>Create listings directly from scan results</li>
                                <li>Get real market pricing data</li>
                                <li>Streamlined selling workflow</li>
                                <li>Automatic listing optimization</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }

        function displayEbayError(errorMessage) {
            console.error('eBay connection error:', errorMessage);
            
            const profileContainer = document.getElementById('ebayConnectionStatus');
            if (profileContainer) {
                profileContainer.innerHTML = `
                    <div class="ebay-connection ebay-disconnected">
                        <div class="ebay-status">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-text">
                                <h4>eBay Connection Error</h4>
                                <p>Error: ${errorMessage}</p>
                                <p>Please try refreshing or reconnecting your eBay account.</p>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="loadEbayAccountInfo()">
                                üîÑ Retry
                            </button>
                            <button class="btn btn-success" onclick="connectEbay()">
                                üîó Reconnect eBay
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // üéØ Enhanced Refresh eBay Connection
        async function refreshEbayConnection() {
            console.log('üîÑ Refreshing eBay connection...');
            
            const refreshButtons = document.querySelectorAll('button[onclick="refreshEbayConnection()"]');
            refreshButtons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'üîÑ Refreshing...';
            });
            
            try {
                const accountInfo = await loadEbayAccountInfo();
                
                if (accountInfo) {
                    showSuccess('eBay connection refreshed successfully!');
                } else {
                    showError('Failed to refresh eBay connection. Please try reconnecting.');
                }
            } catch (error) {
                console.error('Error refreshing eBay connection:', error);
                showError('Error refreshing eBay connection: ' + error.message);
            } finally {
                refreshButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = 'üîÑ Refresh Connection';
                });
            }
        }

        function connectEbay() {
            console.log('üîó Redirecting to eBay connection...');
            window.location.href = '/ebay-connect.html';
        }

        // üéØ Enhanced Disconnect eBay Function
        async function disconnectEbay() {
            if (!confirm('Are you sure you want to disconnect your eBay account? You will no longer be able to create listings directly.')) {
                return;
            }
            
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('No authenticated user');
                }
                
                showLoading(true);
                
                await db.collection('users').doc(user.uid).update({
                    'ebay.isConnected': false,
                    'ebay.accessToken': null,
                    'ebay.refreshToken': null,
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ eBay account disconnected');
                displayEbayNotConnected();
                showSuccess('eBay account disconnected successfully');
                
            } catch (error) {
                console.error('Error disconnecting eBay:', error);
                showError('Failed to disconnect eBay: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // üéØ eBay Connection Success Handler
        async function handleEbayConnectionSuccess(data) {
            console.log('üéâ eBay connection successful:', data);
            
            try {
                const accountInfo = data.accountInfo;
                const successMessage = `Successfully connected to eBay as ${accountInfo.displayName || accountInfo.username}!`;
                
                showSuccess(successMessage);
                displayEbayAccountInfo(accountInfo);
                
                if (typeof userData !== 'undefined') {
                    userData.ebay = {
                        isConnected: true,
                        username: accountInfo.username,
                        displayName: accountInfo.displayName,
                        sellerAccount: accountInfo.sellerAccount,
                        canList: accountInfo.canList,
                        connectedAt: accountInfo.connectedAt,
                        environment: data.environment
                    };
                }
                
                setTimeout(async () => {
                    console.log('üîÑ Refreshing page data after eBay connection...');
                    await loadUserProfile();
                    await loadEbayAccountInfo();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error handling eBay connection success:', error);
                showError('eBay connected successfully, but there was an error updating the display. Please refresh the page.');
            }
        }

        function handleEbayConnectionError(error) {
            console.error('‚ùå eBay connection failed:', error);
            
            let errorMessage = 'Failed to connect to eBay. ';
            
            if (error.message) {
                if (error.message.includes('user_cancelled')) {
                    errorMessage += 'You cancelled the connection process.';
                } else if (error.message.includes('access_denied')) {
                    errorMessage += 'Access was denied. Please try again and approve the connection.';
                } else if (error.message.includes('invalid_request')) {
                    errorMessage += 'There was a problem with the connection request. Please try again.';
                } else {
                    errorMessage += error.message;
                }
            } else {
                errorMessage += 'Please try again or contact support if the problem persists.';
            }
            
            showError(errorMessage);
            displayEbayNotConnected();
        }

        function initializeEbayConnectionHandling() {
            const urlParams = new URLSearchParams(window.location.search);
            const ebaySuccess = urlParams.get('ebay_success');
            const ebayError = urlParams.get('ebay_error');
            
            if (ebaySuccess === 'true') {
                console.log('üîç Detected eBay OAuth success return');
                
                const connectionData = localStorage.getItem('ebay_connection_data');
                
                if (connectionData) {
                    try {
                        const data = JSON.parse(connectionData);
                        handleEbayConnectionSuccess(data);
                        localStorage.removeItem('ebay_connection_data');
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    } catch (parseError) {
                        console.error('Error parsing eBay connection data:', parseError);
                        showError('eBay connection was successful, but there was an error processing the data. Please refresh the page.');
                    }
                } else {
                    console.warn('eBay success detected but no connection data found');
                    showSuccess('eBay account connected successfully!');
                    setTimeout(loadEbayAccountInfo, 1000);
                }
            }
            
            if (ebayError) {
                console.log('üîç Detected eBay OAuth error return');
                handleEbayConnectionError({ message: ebayError });
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                
                setTimeout(() => {
                    initializeEbayConnectionHandling();
                }, 500);
            } else {
                window.location.href = '/signin.html';
            }
        });

        // Load user profile data
        async function loadUserProfile() {
            try {
                showLoading(true);
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    originalData = { ...userData };
                    
                    populateProfile();
                } else {
                    showError('User profile not found');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Failed to load profile: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Populate profile information
        function populateProfile() {
            const initials = getInitials(userData.profile || currentUser.displayName || 'TH');
            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('profileName').textContent = userData.profile || currentUser.displayName || 'Treasure Hunter';
            document.getElementById('profileEmail').textContent = userData.email || currentUser.email;
            
            const stats = userData.stats || {};
            document.getElementById('totalScansCount').textContent = stats.totalScans || 0;
            document.getElementById('totalEarningsAmount').textContent = `${(stats.totalEarnings || 0).toFixed(2)}`;
            document.getElementById('communityRatingValue').textContent = (userData.verification?.communityRating || 0).toFixed(1);
            
            document.getElementById('displayName').value = userData.profile || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('location').value = userData.location || '';
            document.getElementById('timezone').value = userData.timezone || 'EST';
            
            loadEbayAccountInfo();
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                profile: document.getElementById('displayName').value.trim(),
                location: document.getElementById('location').value.trim(),
                timezone: document.getElementById('timezone').value
            };
            
            if (!formData.profile) {
                showError('Display name is required');
                return;
            }
            
            try {
                showLoading(true);
                
                await db.collection('users').doc(currentUser.uid).update({
                    ...formData,
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await currentUser.updateProfile({
                    displayName: formData.profile
                });
                
                userData = { ...userData, ...formData };
                
                document.getElementById('profileName').textContent = formData.profile;
                document.getElementById('profileAvatar').textContent = getInitials(formData.profile);
                
                showSuccess('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showError('Failed to update profile: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Feedback form submission
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const feedback = document.getElementById('feedback').value.trim();
            
            if (!feedback) {
                showError('Please enter your feedback');
                return;
            }
            
            try {
                showLoading(true);
                
                await db.collection('feedback').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    feedback: feedback,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
                
                document.getElementById('feedback').value = '';
                showSuccess('Thank you for your feedback! We appreciate your input.');
                
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showError('Failed to submit feedback: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Security functions
        function changePassword() {
            if (!currentUser.email) {
                showError('Cannot change password for social login accounts');
                return;
            }
            
            const email = currentUser.email;
            
            if (confirm(`Send password reset email to ${email}?`)) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showSuccess('Password reset email sent! Check your inbox.');
                    })
                    .catch((error) => {
                        console.error('Password reset error:', error);
                        showError('Failed to send password reset email: ' + error.message);
                    });
            }
        }

        function enableTwoFactor() {
            showInfo('Two-factor authentication setup coming soon!');
        }

        function deleteAccount() {
            const confirmText = 'DELETE';
            const userInput = prompt(
                `‚ö†Ô∏è WARNING: This will permanently delete your account and all data.\n\n` +
                `This action cannot be undone. All your scans, listings, and profile data will be lost.\n\n` +
                `Type "${confirmText}" to confirm account deletion:`
            );
            
            if (userInput !== confirmText) {
                if (userInput !== null) {
                    showError('Account deletion cancelled - confirmation text did not match');
                }
                return;
            }
            
            if (confirm('Are you absolutely sure? This action cannot be undone.')) {
                deleteAccountPermanently();
            }
        }

        async function deleteAccountPermanently() {
            try {
                showLoading(true);
                
                await deleteUserData();
                await currentUser.delete();
                
                localStorage.setItem('accountDeleted', 'true');
                window.location.href = '/signin.html';
                
            } catch (error) {
                console.error('Error deleting account:', error);
                showError('Failed to delete account: ' + error.message);
                showLoading(false);
            }
        }

        async function deleteUserData() {
            const batch = db.batch();
            
            const userRef = db.collection('users').doc(currentUser.uid);
            batch.delete(userRef);
            
            const scansQuery = await db.collection('users')
                .doc(currentUser.uid)
                .collection('scans')
                .get();
            
            scansQuery.forEach((doc) => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
        }

        function resetForm() {
            if (originalData) {
                document.getElementById('displayName').value = originalData.profile || '';
                document.getElementById('location').value = originalData.location || '';
                document.getElementById('timezone').value = originalData.timezone || 'EST';
                
                showSuccess('Form reset to original values');
            }
        }

        // Utility functions
        function getInitials(name) {
            if (!name) return 'TH';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function showLoading(show) {
            const buttons = document.querySelectorAll('button[type="submit"]');
            buttons.forEach(btn => {
                btn.disabled = show;
                if (show) {
                    btn.textContent = 'Loading...';
                }
            });
        }

        function showSuccess(message) {
            console.log('‚úÖ', message);
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                successDiv.scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 5000);
            } else {
                createTemporaryMessage(message, 'success');
            }
        }

        function showError(message) {
            console.error('‚ùå', message);
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                createTemporaryMessage(message, 'error');
            }
        }

        function showInfo(message) {
            showSuccess(message);
        }

        function createTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, type === 'success' ? 5000 : 8000);
        }

        // Auto-save form changes (debounced)
        let saveTimeout;
        const formInputs = ['displayName', 'location', 'timezone'];
        
        formInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        console.log('Auto-saving profile changes...');
                    }, 2000);
                });
            }
        });

        // Check for account deletion message and handle eBay connection
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('accountDeleted')) {
                localStorage.removeItem('accountDeleted');
                showSuccess('Account deleted successfully');
            }
            
            if (window.location.hash === '#ebay') {
                setTimeout(() => {
                    document.getElementById('ebaySection').scrollIntoView({ behavior: 'smooth' });
                }, 500);
            }

            // Initialize eBay connection handling
            initializeEbayConnectionHandling();
        });
    </script>
</body>
</html>