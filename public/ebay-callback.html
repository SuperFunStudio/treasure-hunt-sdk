<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay Connection - Treasure Hunter</title>
    <style>
        /* Existing styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .callback-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .status-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .status-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .status-message {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .close-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .error-details {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-size: 14px;
        }
        
        .debug-info {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div class="status-title">Processing eBay Connection</div>
            <div class="status-message">Please wait while we complete your eBay account connection...</div>
        </div>

        <!-- Success State -->
        <div id="successState" class="success" style="display: none;">
            <div class="status-icon">‚úÖ</div>
            <div class="status-title">Connection Successful!</div>
            <div class="status-message">Your eBay account has been connected successfully. This window will close automatically.</div>
            <button class="close-btn" onclick="closeWindow()">Close Window</button>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error" style="display: none;">
            <div class="status-icon">‚ùå</div>
            <div class="status-title">Connection Failed</div>
            <div class="status-message">There was an issue connecting your eBay account.</div>
            <div id="errorDetails" class="error-details" style="display: none;"></div>
            <div id="debugInfo" class="debug-info" style="display: none;"></div>
            <button class="close-btn" onclick="closeWindow()">Close Window</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDymYwo7NUAu7lhoPfS9KLQmckvVgky7PU",
            authDomain: "treasurehunter-sdk.firebaseapp.com",
            projectId: "treasurehunter-sdk",
            storageBucket: "treasurehunter-sdk.firebasestorage.app",
            messagingSenderId: "328804663359",
            appId: "1:328804663359:web:eb124f150c4853c123788a",
            measurementId: "G-YNJ58GLX3T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Configuration
        const API_BASE_URL = 'https://us-central1-treasurehunter-sdk.cloudfunctions.net';

        // UI Elements
        const loadingState = document.getElementById('loadingState');
        const successState = document.getElementById('successState');
        const errorState = document.getElementById('errorState');
        const errorDetails = document.getElementById('errorDetails');
        const debugInfo = document.getElementById('debugInfo');

        // üö® ENHANCED: Better callback processing with detailed debugging
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîç eBay callback page loaded');
            
            try {
                // Get URL parameters with detailed logging
                const urlParams = new URLSearchParams(window.location.search);
                const urlData = {
                    fullUrl: window.location.href,
                    search: window.location.search,
                    code: urlParams.get('code'),
                    error: urlParams.get('error') || urlParams.get('error_description'),
                    state: urlParams.get('state'),
                    expires_in: urlParams.get('expires_in'),
                    all_params: Object.fromEntries(urlParams.entries())
                };
                
                console.log('üìã Callback URL analysis:', urlData);
                
                // Show debug info for troubleshooting
                debugInfo.innerHTML = `
                    <strong>üîç Debug Information:</strong><br>
                    <strong>Full URL:</strong> ${urlData.fullUrl}<br>
                    <strong>Code present:</strong> ${!!urlData.code}<br>
                    <strong>Error present:</strong> ${!!urlData.error}<br>
                    <strong>State present:</strong> ${!!urlData.state}<br>
                    <strong>All parameters:</strong> ${JSON.stringify(urlData.all_params, null, 2)}
                `;

                // üö® FIX: Better error detection and handling
                if (urlData.error) {
                    // Handle eBay OAuth errors
                    const errorMessage = urlData.error === 'access_denied' 
                        ? 'You declined to authorize the application'
                        : `eBay OAuth error: ${urlData.error}`;
                    
                    handleError(errorMessage, urlData);
                    return;
                }

                // Check for authorization code
                if (!urlData.code) {
                    handleError('No authorization code received from eBay. This might indicate a configuration issue.', urlData);
                    return;
                }

                // Log successful code receipt
                console.log('‚úÖ Authorization code received:', urlData.code.substring(0, 20) + '...');

                // Wait for Firebase Auth to initialize
                console.log('‚è≥ Waiting for Firebase Auth...');
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        if (user) {
                            console.log('‚úÖ User authenticated:', user.uid);
                            resolve(user);
                        } else {
                            reject(new Error('User not authenticated'));
                        }
                    });
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        unsubscribe();
                        reject(new Error('Authentication timeout'));
                    }, 10000);
                });

                const user = auth.currentUser;
                if (!user) {
                    handleError('User authentication required. Please login first.', urlData);
                    return;
                }

                console.log('üîÑ Processing eBay OAuth callback for user:', user.uid);

                // üö® FIX: Enhanced backend call with better error handling
                const requestBody = {
                    code: urlData.code,
                    state: urlData.state,
                    userId: user.uid
                };

                console.log('üì§ Sending to backend:', { 
                    ...requestBody, 
                    code: requestBody.code.substring(0, 20) + '...' // Don't log full code
                });

                const response = await fetch(`${API_BASE_URL}/ebayAuth/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await user.getIdToken(true)}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì• Backend response status:', response.status);
                
                let responseData;
                try {
                    const responseText = await response.text();
                    console.log('üì• Raw backend response:', responseText);
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    const errorText = await response.text();
                    throw new Error(`Invalid JSON response from backend: ${errorText}`);
                }

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status} - ${responseData.error || 'Unknown error'}`);
                }

                if (!responseData.success) {
                    throw new Error(responseData.error || 'eBay connection failed');
                }

                console.log('‚úÖ Backend processing successful:', responseData);

                // Update user document in Firestore
                await updateUserEbayConnection(user.uid, responseData);

                // Show success and notify parent window
                handleSuccess(responseData);

            } catch (error) {
                console.error('‚ùå Callback processing error:', error);
                handleError(error.message, { error_details: error.stack });
            }
        });

        // üö® ENHANCED: Better success handling
        function handleSuccess(data) {
            console.log('üéâ eBay connection successful:', data);
            
            // Hide loading, show success
            loadingState.style.display = 'none';
            successState.style.display = 'block';
            debugInfo.style.display = 'none';
            
            // Update success message
            const statusMessage = successState.querySelector('.status-message');
            statusMessage.textContent = data.sellerAccount 
                ? `Your eBay seller account "${data.sellerAccount}" has been connected successfully.`
                : 'Your eBay account has been connected successfully.';

            // Notify parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'EBAY_AUTH_SUCCESS',
                    sellerAccount: data.sellerAccount,
                    data: data
                }, window.location.origin);
                
                console.log('üì° Success message sent to parent window');
            }

            // Auto-close after 3 seconds
            setTimeout(() => {
                closeWindow();
            }, 3000);
        }

        // üö® ENHANCED: Better error handling with detailed debugging
        function handleError(errorMessage, debugData = {}) {
            console.error('‚ùå eBay connection error:', errorMessage);
            
            // Hide loading, show error
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            
            // Categorize error types for better user guidance
            let userFriendlyMessage = errorMessage;
            let helpText = '';
            let isConfigurationError = false;
            
            if (errorMessage.includes('invalid_request') || errorMessage.includes('redirect_uri')) {
                isConfigurationError = true;
                userFriendlyMessage = 'eBay OAuth configuration error';
                helpText = `
                    <h4>üîß Configuration Issue Detected</h4>
                    <p><strong>This is likely a redirect URI mismatch.</strong></p>
                    <p>The developer needs to:</p>
                    <ul>
                        <li>Use the correct eBay RuName (not a regular URL)</li>
                        <li>Ensure the RuName is configured properly in eBay Developer Console</li>
                        <li>Update the environment variables with the correct RuName</li>
                    </ul>
                `;
            } else if (errorMessage.includes('access_denied') || errorMessage.includes('declined')) {
                userFriendlyMessage = 'Authorization declined';
                helpText = `
                    <h4>‚ùå You declined to authorize the application</h4>
                    <p>To connect your eBay account, you need to:</p>
                    <ul>
                        <li>Click "Agree and Continue" on the eBay authorization page</li>
                        <li>Accept all the requested permissions</li>
                        <li>Make sure you have an eBay seller account</li>
                    </ul>
                    <button onclick="window.location.href='/ebay-connect.html'" class="close-btn" style="margin-top: 10px;">
                        üîÑ Try Again
                    </button>
                `;
            } else if (errorMessage.includes('authentication') || errorMessage.includes('login')) {
                userFriendlyMessage = 'Authentication required';
                helpText = `
                    <h4>üîê Please login first</h4>
                    <p>You need to be logged into Treasure Hunter before connecting eBay.</p>
                    <button onclick="window.location.href='/signin.html'" class="close-btn" style="margin-top: 10px;">
                        üîë Go to Login
                    </button>
                `;
            } else if (errorMessage.includes('seller') || errorMessage.includes('permission')) {
                userFriendlyMessage = 'eBay seller account required';
                helpText = `
                    <h4>üè™ eBay Seller Account Required</h4>
                    <p>Your eBay account needs seller permissions:</p>
                    <ul>
                        <li>Verify your identity with eBay</li>
                        <li>Add a payment method</li>
                        <li>Complete seller registration</li>
                    </ul>
                    <a href="https://www.ebay.com/help/selling/getting-started-selling/selling-basics" target="_blank" class="close-btn" style="margin-top: 10px;">
                        üìö Setup eBay Selling
                    </a>
                `;
            }
            
            // Show error details
            errorDetails.innerHTML = `
                <h4>${userFriendlyMessage}</h4>
                ${helpText}
                ${isConfigurationError ? '<p><em>Note: This appears to be a configuration issue that the developer needs to fix.</em></p>' : ''}
            `;
            errorDetails.style.display = 'block';
            
            // Show debug information
            if (debugData && Object.keys(debugData).length > 0) {
                const debugContent = `
                    <strong>üêõ Technical Details:</strong><br>
                    <strong>Error:</strong> ${errorMessage}<br>
                    <strong>Timestamp:</strong> ${new Date().toISOString()}<br>
                    <strong>URL:</strong> ${window.location.href}<br>
                    ${debugData.fullUrl ? `<strong>Full URL:</strong> ${debugData.fullUrl}<br>` : ''}
                    ${debugData.all_params ? `<strong>URL Parameters:</strong> ${JSON.stringify(debugData.all_params, null, 2)}<br>` : ''}
                    ${debugData.error_details ? `<strong>Stack Trace:</strong> ${debugData.error_details}<br>` : ''}
                `;
                debugInfo.innerHTML = debugContent;
                debugInfo.style.display = 'block';
            }

            // Notify parent window
            if (window.opener) {
                window.opener.postMessage({
                    type: 'EBAY_AUTH_ERROR',
                    error: errorMessage,
                    isConfigurationError: isConfigurationError,
                    debugData: debugData
                }, window.location.origin);
                
                console.log('üì° Error message sent to parent window');
            }
        }

        // Update user's eBay connection in Firestore
        async function updateUserEbayConnection(userId, connectionData) {
            try {
                const updateData = {
                    'ebay.isConnected': true,
                    'ebay.sellerAccount': connectionData.sellerAccount || 'Connected',
                    'ebay.environment': connectionData.environment || 'production',
                    'ebay.connectedAt': firebase.firestore.FieldValue.serverTimestamp(),
                    'metadata.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(userId).update(updateData);
                console.log('‚úÖ User eBay connection updated in Firestore');

            } catch (error) {
                console.error('‚ùå Error updating user eBay connection:', error);
                throw new Error('Failed to save eBay connection to database');
            }
        }

        // Close the popup window
        function closeWindow() {
            console.log('üîΩ Closing eBay callback window');
            
            try {
                if (window.opener) {
                    window.close();
                } else {
                    // If no opener, redirect to the main app
                    window.location.href = '/dashboard.html';
                }
            } catch (error) {
                console.error('‚ùå Error closing window:', error);
                // Fallback redirect
                window.location.href = '/dashboard.html';
            }
        }

        // Handle popup being closed manually
        window.addEventListener('beforeunload', () => {
            if (window.opener && !successState.style.display) {
                // Only notify if we haven't already sent a success message
                window.opener.postMessage({
                    type: 'EBAY_AUTH_CANCELLED'
                }, window.location.origin);
            }
        });

        // Add keyboard shortcut to close window
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Enter') {
                closeWindow();
            }
        });

        // üö® NEW: Auto-retry mechanism for common transient errors
        async function autoRetryIfPossible(error) {
            const retryableErrors = [
                'network',
                'timeout',
                'fetch failed',
                'connection refused'
            ];
            
            const isRetryable = retryableErrors.some(retryError => 
                error.message.toLowerCase().includes(retryError)
            );
            
            if (isRetryable && !window.retryAttempted) {
                console.log('üîÑ Attempting auto-retry for transient error...');
                window.retryAttempted = true;
                
                // Wait 2 seconds and retry
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
                return true;
            }
            
            return false;
        }

        // üö® NEW: Connection health check
        async function performHealthCheck() {
            try {
                const response = await fetch(`${API_BASE_URL}/ebayAuth/test`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Backend health check passed:', data);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è Backend health check failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Backend health check error:', error);
                return false;
            }
        }

        // üö® NEW: Enhanced initialization with health check
        window.addEventListener('load', async () => {
            console.log('üîç Performing initial health check...');
            const healthOk = await performHealthCheck();
            
            if (!healthOk) {
                handleError('Backend service unavailable. Please try again later.', {
                    health_check_failed: true,
                    backend_url: API_BASE_URL
                });
            }
        });
    </script>
</body>
</html>